select t1.user_id,t1.firstseen,t1.lastseen,t1.name,t1.mac,t2.accounts,t1.data_in,t1.data_out,t2.connections from (select users.timestamp AS firstseen,usage.timestamp AS lastseen,users.name AS name,mac,sum(data_in) as data_in,sum(data_out) as data_out,user_id from usage join users on usage.user_id=users.id {1} group by mac) t1 left join (select user_id,group_concat(DISTINCT account) AS accounts, count(*) AS connections from connections {2} group by user_id) t2 on t1.user_id=t2.user_id;