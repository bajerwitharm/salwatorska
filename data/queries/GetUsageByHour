select t10.hour as hour,users.mac as mac, account, name, sum(t10.data_in) as data_in,sum(t10.data_out) as data_out from (select strftime('%H',t1.timestamp) as hour,user_id,t2.data_in-t1.data_in as data_in,t2.data_out - t1.data_out as data_out from usage t1 inner join usage t2 using(user_id) where t2.timestamp>datetime(t1.timestamp,'+1 hours') group by t2.id) t10 join users on t10.user_id=users.id left join connections using(mac) group by t10.hour,t10.user_id;