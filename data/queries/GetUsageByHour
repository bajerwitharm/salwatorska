select t10.hour as hour,t10.mac as mac, account, name, sum(t10.data_in) as data_in,sum(t10.data_out) as data_out from (select strftime('%H',t1.timestamp) as hour,mac,t2.data_in-t1.data_in as data_in,t2.data_out - t1.data_out as data_out from usage t1 inner join usage t2 using(mac) where strftime('%s',t2.timestamp)-strftime('%s',t1.timestamp)>3600 group by t2.timestamp) t10 join connections using(mac) join users using(mac) group by t10.hour,t10.mac;