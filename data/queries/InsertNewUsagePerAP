INSERT INTO usage_by_ap(timestamp,user_id, data_in, data_out, ap) select timestamp, user_id, sum(data_in), sum(data_out), ap from (select timestamp, user_id, data_in, data_out, (select ap from connections where timestamp<usage.timestamp order by id desc limit 1) as ap from usage where date(timestamp)>ifnull((select max(timestamp) from usage_by_ap),'2004-01-01 02:34:56')) group by user_id, ap,date(timestamp);